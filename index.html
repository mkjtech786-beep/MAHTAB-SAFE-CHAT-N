<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Chat</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ----------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAqfguS1ucAtklcl06eB1JIWQr46XMpe7g",
  authDomain: "safe-chat-c0b9c.firebaseapp.com",
  databaseURL: "https://safe-chat-c0b9c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "safe-chat-c0b9c",
  storageBucket: "safe-chat-c0b9c.firebasestorage.app",
  messagingSenderId: "119640275300",
  appId: "1:119640275300:web:20ae984f4af1ffe6a62271"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ----------- VARIABLES ---------------- */
let currentUser = null;
const usersDiv = document.getElementById("users-list");
const msgsBox = document.getElementById("msgs");

/* ----------- NOTIFICATION ---------------- */
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}
function showNotification(user, msg) {
  if (document.visibilityState === "visible") return;
  new Notification("New message", { body: user + ": " + msg });
}

/* ----------- USERS LIST + BADGE ---------------- */
onValue(ref(db, "chats"), snap => {
  usersDiv.innerHTML = "";
  snap.forEach(child => {
    const uid = child.key;
    const data = child.val();

    const d = document.createElement("div");
    d.className = "user";

    const name = document.createElement("span");
    name.className = "username";
    name.innerText = uid;
    d.appendChild(name);

    if (data.unread > 0) {
      const badge = document.createElement("span");
      badge.className = "unread-badge";
      badge.innerText = data.unread;
      d.appendChild(badge);
    }

    const online = document.createElement("span");
    online.className = "online";
    online.style.background =
      data.blocked ? "gray" :
      data.lastActive && Date.now() - data.lastActive < 60000 ? "lime" : "red";
    d.appendChild(online);

    const blockBtn = document.createElement("button");
    blockBtn.className = "block-btn";
    blockBtn.innerText = data.blocked ? "Unblock" : "Block";
    blockBtn.onclick = () =>
      update(ref(db, "chats/" + uid), { blocked: !data.blocked });
    d.appendChild(blockBtn);

    d.onclick = e => {
      if (!e.target.classList.contains("block-btn")) openChat(uid);
    };

    usersDiv.appendChild(d);
  });
});

/* ----------- OPEN CHAT ---------------- */
window.openChat = uid => {
  currentUser = uid;
  document.getElementById("chatName").innerText = uid;
  update(ref(db, "chats/" + uid), { unread: 0 });

  onValue(ref(db, "chats/" + uid), snap => {
    msgsBox.innerHTML = "";
    snap.forEach(m => {
      const val = m.val();
      if (!val || (!val.text && !val.voice && !val.image)) return;

      const d = document.createElement("div");
      d.className = "msg " + val.from;

      // TEXT
      if (val.text) d.innerText = val.text;

      // VOICE
      if (val.voice) {
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = val.voice;
        audio.style.display = "block";
        audio.style.marginTop = "4px";
        d.appendChild(audio);
      }

      // IMAGE
      if (val.image) {
        const img = document.createElement("img");
        img.src = val.image;
        img.style.maxWidth = "200px";
        img.style.borderRadius = "12px";
        img.style.marginTop = "5px";
        img.style.cursor = "pointer";
        img.onclick = () => window.open(val.image, "_blank");
        d.appendChild(img);
      }

      // TIME
      if(val.time){
        const timeSpan = document.createElement("span");
        timeSpan.className = "msg-time";
        const date = new Date(val.time);
        let hours = date.getHours();
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        timeSpan.innerText = `${hours}:${minutes} ${ampm}`;
        d.appendChild(timeSpan);
      }

      msgsBox.appendChild(d);
    });
    msgsBox.scrollTop = msgsBox.scrollHeight;
  });
};

/* ----------- SEND MESSAGE ---------------- */
window.sendMsg = () => {
  if (!currentUser) return alert("User select karo");
  const input = document.getElementById("text");
  if (!input.value) return;

  push(ref(db, "chats/" + currentUser), {
    from: "admin",
    text: input.value,
    time: Date.now()
  });
  input.value = "";
};

/* ----------- SEND IMAGE ---------------- */
window.sendImage = () => {
  if (!currentUser) return alert("User select karo");
  const imageInput = document.getElementById("imageInput");
  imageInput.click();

  imageInput.onchange = () => {
    const file = imageInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onloadend = () => {
      const base64Image = reader.result;
      push(ref(db, "chats/" + currentUser), {
        from: "admin",
        image: base64Image,
        time: Date.now()
      });
    };
    imageInput.value = "";
  };
};

/* ----------- UNREAD + NOTIFICATION ---------------- */
onValue(ref(db, "chats"), snap => {
  snap.forEach(userSnap => {
    const uid = userSnap.key;
    userSnap.forEach(msgSnap => {
      const msg = msgSnap.val();
      if (msg && msg.from === "user" && !msg.read && currentUser !== uid) {
        update(ref(db, "chats/" + uid), {
          unread: (userSnap.val().unread || 0) + 1
        });
        update(ref(db, "chats/" + uid + "/" + msgSnap.key), { read: true });
        showNotification(uid, msg.text || "Voice/Image message");
      }
    });
  });
});

/* ----------- VOICE RECORD + TIMER ---------------- */
let mediaRecorder, audioChunks = [];
let timer, seconds = 0;

const micBtn = document.getElementById("micBtn");
const recordUI = document.getElementById("recordUI");
const recTime = document.getElementById("recTime");

function startTimer() {
  seconds = 0;
  recTime.innerText = "00:00";
  timer = setInterval(() => {
    seconds++;
    recTime.innerText =
      String(Math.floor(seconds / 60)).padStart(2, "0") + ":" +
      String(seconds % 60).padStart(2, "0");
  }, 1000);
}

function stopTimer() {
  clearInterval(timer);
  recordUI.style.display = "none";
}

micBtn.onclick = async () => {
  if (!currentUser) return alert("User select karo");

  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      const reader = new FileReader();
      reader.readAsDataURL(blob);
      reader.onloadend = () => {
        push(ref(db, "chats/" + currentUser), {
          from: "admin",
          voice: reader.result,
          time: Date.now()
        });
      };
    };

    mediaRecorder.start();
    micBtn.textContent = "‚èπ";
    recordUI.style.display = "flex";
    startTimer();
  } else {
    mediaRecorder.stop();
    micBtn.textContent = "üé§";
    stopTimer();
  }
};
</script>

<style>
body{margin:0;font-family:Poppins;background:#0b0a1a;color:#fff}
.app{display:flex;flex-direction:column;height:100vh}
.header{padding:14px;background:#120c22;text-align:center}
.users-container{max-height:200px;overflow-y:auto;padding:10px;background:#1a0f3f}
.user{display:flex;align-items:center;justify-content:space-between;padding:10px;margin-bottom:6px;background:#2a1b55;border-radius:8px;cursor:pointer}
.username{font-weight:500}
.unread-badge{background:red;color:#fff;font-size:11px;padding:2px 6px;border-radius:12px}
.online{width:10px;height:10px;border-radius:50%}
.block-btn{background:#ff2f6d;color:#fff;border:none;border-radius:6px;padding:2px 6px}
.chat{flex:1;display:flex;flex-direction:column}
.msgs{flex:1;padding:10px;background:#120c22;margin:10px;border-radius:12px;overflow-y:auto}
.msg{position:relative;padding:8px 12px;border-radius:16px;margin-bottom:6px;max-width:70%;word-wrap:break-word}
.msg.user{background:#1e90ff;margin-left:auto;border-bottom-right-radius:0}
.msg.admin{background:#ff2f6d;margin-right:auto;border-bottom-left-radius:0}
.msg img{max-width:200px;border-radius:12px;margin-top:5px;cursor:pointer}
.msg-time{font-size:10px;color:#eee;position:absolute;bottom:2px;right:6px}
.input{display:flex;align-items:center;padding:10px}
input{flex:1;padding:10px;border-radius:20px;border:none}
button{margin-left:8px;border:none;border-radius:50%;width:40px;height:40px;background:#ff2f6d;color:#fff}
.mic-btn{background:#1e90ff}
.record-ui{display:none;align-items:center;gap:6px;color:#ff4d4d;font-size:13px}
.rec-dot{width:8px;height:8px;background:red;border-radius:50%;animation:blink 1s infinite}
@keyframes blink{0%{opacity:1}50%{opacity:.2}100%{opacity:1}}
</style>

</head>

<body>
<div class="app">
  <div class="header">
    <div>Admin Chat</div>
    <div class="users-container" id="users-list"></div>
  </div>

  <div class="chat">
    <div class="header">Chat with: <span id="chatName">Select User</span></div>
    <div class="msgs" id="msgs"></div>

    <div class="input">
      <input id="text" placeholder="Type message...">
      <button onclick="sendMsg()">‚û§</button>
      <button onclick="sendImage()" title="Send Image">üñºÔ∏è</button>

      <div class="record-ui" id="recordUI">
        <span class="rec-dot"></span>
        <span id="recTime">00:00</span>
      </div>

      <button id="micBtn" class="mic-btn">üé§</button>
      <input type="file" id="imageInput" accept="image/*" style="display:none">
    </div>
  </div>
</div>
</body>
</html>
